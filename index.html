<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Happy Birthday, Bestie! 🎉</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<meta name="theme-color" content="#6c8cff"/>

<style>
:root{
  --primary:#6c8cff; --accent:#ffd166;
  --bg1:#0f1024; --bg2:#2a1758; --bg3:#5b2da6;
  --paper:#fff7fb; --ink:#231a21;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#fff;
  background:
    radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent 60%),
    radial-gradient(900px 700px at -10% 10%, var(--bg2), transparent 55%),
    radial-gradient(1400px 900px at 50% 120%, var(--bg1), #0b0610);
  overflow-x:hidden;
}
.container{max-width:980px;margin:0 auto;padding:20px}

h1{margin:18px 0 8px;font-size:clamp(28px,6vw,56px)}
.sub{opacity:.9;margin:0 0 10px}

/* Card shells */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);
  border-radius:20px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
}

/* Buttons */
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;margin:6px 8px 0 0}
.btn.primary{background:var(--accent);color:#201414;box-shadow:0 10px 20px rgba(255,209,102,.35)}
.btn.secondary{background:#e7ebff;color:#151a3a;box-shadow:0 10px 20px rgba(108,140,255,.28)}
.btn.ghost{background:transparent;color:#fff;border:1px dashed rgba(255,255,255,.4)}

/* Cake */
#cake-zone{padding:24px}
.cake-wrap{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:center}
@media (max-width:900px){.cake-wrap{grid-template-columns:1fr}}
.cake-svg{width:100%;height:auto;display:block}
.flame{transform-origin:center;animation:flicker .15s infinite alternate}
@keyframes flicker{from{transform:scale(1) translateY(0)}to{transform:scale(.92) translateY(1px)}}
.flame.out{opacity:0;filter:blur(1.5px);animation:none;transition:opacity .35s ease}
.smoke{opacity:0;transition:opacity .6s ease}
.smoke.show{opacity:1;animation:smokeUp 1.2s ease forwards}
@keyframes smokeUp{0%{transform:translateY(0) scale(.8);opacity:.9}100%{transform:translateY(-60px) scale(1.1);opacity:0}}
.meter{height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden;margin:10px 0 6px}
.meter>.bar{height:100%;width:0%;background:linear-gradient(90deg,#a6b7ff,#ffd166)}
.hint{font-size:14px;opacity:.85;margin:6px 0 10px}
.status{font-weight:700}

/* Film roll column (hidden before blow) */
#roll-zone{display:none;margin-top:18px;padding:16px}
.roll-wrap{max-height:70vh;overflow:auto;scroll-behavior:smooth}
.vertical-roll{display:flex;flex-direction:column;gap:14px}

/* frame item */
.frame{
  position:relative;width:min(520px,94vw);margin:0 auto;border-radius:16px;overflow:hidden;
  box-shadow:0 14px 30px rgba(0,0,0,.28);background:#000;
}
.frame img,.frame video{display:block;width:100%;height:auto;object-fit:cover}
.frame video{max-height:640px}
.frame svg.film{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

/* Greeting card / envelope (appears last) */
#letter{display:none;margin-top:18px;padding:20px}
.envelope{position:relative;width:min(520px,92vw);height:320px;margin:0 auto;cursor:pointer;perspective:1200px}
.env-body{position:absolute;inset:0;background:linear-gradient(160deg,#e7ebff,#fff);border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.28)}
.flap{position:absolute;left:0;right:0;top:0;height:52%;background:linear-gradient(160deg,#d6ddff,#f5f7ff);
      clip-path:polygon(0 0,100% 0,50% 100%);transform-origin:top;transition:transform .8s cubic-bezier(.2,.8,.2,1);
      border-top-left-radius:14px;border-top-right-radius:14px;border-bottom:1px solid rgba(0,0,0,.06)}
.letter-card{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:86%;height:72%;background:var(--paper);color:var(--ink);
             border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.18);transition:transform .8s cubic-bezier(.2,.8,.2,1);overflow:auto}
.envelope.open .flap{transform:rotateX(180deg)} .envelope.open .letter-card{transform:translate(-50%,-58%)}
.seal{position:absolute;left:50%;top:52%;transform:translate(-50%,-50%);width:54px;height:54px;border-radius:50%;
      background:var(--primary);box-shadow:0 6px 18px rgba(108,140,255,.45), inset 0 2px 0 rgba(255,255,255,.4);
      display:grid;place-items:center;color:#fff;font-weight:800}

footer{text-align:center;padding:28px 12px 42px;opacity:.78;font-size:13px}
</style>
</head>
<body>

<div class="container" style="text-align:center">
  <h1>Happy Birthday, <span style="background:linear-gradient(90deg,#e0e7ff,#ffe37b,#e0e7ff);-webkit-background-clip:text;background-clip:text;color:transparent">Bestie</span> 🎉</h1>
  <p class="sub">Blow the candles first — then the memories slide down like an old film roll 🎞️</p>
  <div>
    <button class="btn primary" id="startBtn">Start & enable mic 🎤</button>
    <button class="btn secondary" id="manualBlowBtn">Blow out now ✨</button>
    <span class="btn ghost" style="pointer-events:none">🔒 mic stays on this device</span>
  </div>
</div>

<section id="cake-zone" class="container card">
  <div class="cake-wrap">
    <div>
      <svg class="cake-svg" viewBox="0 0 520 360" role="img" aria-label="Birthday cake with five candles">
        <defs>
          <radialGradient id="icing" cx="50%" cy="20%" r="80%"><stop offset="0%" stop-color="#e7ebff"/><stop offset="100%" stop-color="#cfd8ff"/></radialGradient>
          <linearGradient id="cakeBody" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#b6bdfc"/><stop offset="100%" stop-color="#6c8cff"/></linearGradient>
          <linearGradient id="wax" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#fff6a6"/><stop offset="100%" stop-color="#ffe37b"/></linearGradient>
          <radialGradient id="flameGrad" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#fffbd1"/><stop offset="60%" stop-color="#ffd166"/><stop offset="100%" stop-color="#ff7b00"/></radialGradient>
          <radialGradient id="smokeGrad" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#ffffffaa"/><stop offset="100%" stop-color="#ffffff00"/></radialGradient>
        </defs>
        <ellipse cx="260" cy="320" rx="180" ry="26" fill="#ffffff22"/>
        <rect x="110" y="150" width="300" height="120" rx="18" fill="url(#cakeBody)"/>
        <path d="M120,160 h280 a16,16 0 0 1 16,16 v12
                 q-24,24 -48,0 q-24,-24 -48,0 q-24,24 -48,0 q-24,-24 -48,0 q-24,24 -48,0 q-24,-24 -48,0 v-12
                 a16,16 0 0 1 16,-16 z" fill="url(#icing)"/>
        <g id="candles">
          <g transform="translate(140,120)"><rect width="16" height="60" rx="8" fill="url(#wax)"/><circle class="smoke" r="8" cx="8" cy="-16" fill="url(#smokeGrad)"/><ellipse class="flame" cx="8" cy="-8" rx="7" ry="12" fill="url(#flameGrad)"/></g>
          <g transform="translate(200,120)"><rect width="16" height="60" rx="8" fill="url(#wax)"/><circle class="smoke" r="8" cx="8" cy="-16" fill="url(#smokeGrad)"/><ellipse class="flame" cx="8" cy="-8" rx="7" ry="12" fill="url(#flameGrad)"/></g>
          <g transform="translate(260,120)"><rect width="16" height="60" rx="8" fill="url(#wax)"/><circle class="smoke" r="8" cx="8" cy="-16" fill="url(#smokeGrad)"/><ellipse class="flame" cx="8" cy="-8" rx="7" ry="12" fill="url(#flameGrad)"/></g>
          <g transform="translate(320,120)"><rect width="16" height="60" rx="8" fill="url(#wax)"/><circle class="smoke" r="8" cx="8" cy="-16" fill="url(#smokeGrad)"/><ellipse class="flame" cx="8" cy="-8" rx="7" ry="12" fill="url(#flameGrad)"/></g>
          <g transform="translate(380,120)"><rect width="16" height="60" rx="8" fill="url(#wax)"/><circle class="smoke" r="8" cx="8" cy="-16" fill="url(#smokeGrad)"/><ellipse class="flame" cx="8" cy="-8" rx="7" ry="12" fill="url(#flameGrad)"/></g>
        </g>
      </svg>
    </div>
    <div>
      <p class="hint">Tap “Start & enable mic” → allow permission → blow towards your mic. If mic isn’t available, use the button.</p>
      <div class="meter"><div id="meterBar" class="bar"></div></div>
      <div id="micStatus" class="status">Waiting to start…</div>
    </div>
  </div>
</section>

<!-- film roll column (appears after blow) -->
<section id="roll-zone" class="container card" aria-label="Film roll memories">
  <h2 style="margin:8px 0 12px">Memories 🎞️</h2>
  <div class="roll-wrap" id="rollWrap">
    <div class="vertical-roll" id="roll"></div>
  </div>
</section>

<!-- greeting card appears last -->
<section id="letter" class="container card" aria-label="Greeting card">
  <h2 style="text-align:center;margin-top:4px">A small note 💌</h2>
  <div class="envelope" id="envelope" role="button" aria-expanded="false" aria-label="Open letter" tabindex="0">
    <div class="env-body"></div>
    <div class="flap"></div>
    <div class="letter-card">
      <p style="margin:0;line-height:1.7">
        Who knew one tiny online coincidence could turn into comfort this big?  
        You’re strong, hardworking, and the sweetest kind of chaos.  
        Make a huge wish — the universe is listening. I’m always cheering for you. ✨
      </p>
    </div>
    <div class="seal" aria-hidden="true">⭐️</div>
  </div>
  <p class="hint" style="text-align:center;margin:10px 0 16px">Tap the envelope to open/close</p>
</section>

<footer>Made with 🫶 by you • Mic needs HTTPS or permission • Videos play muted by default</footer>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/* -------------- MEDIA LIST --------------
   Place these files next to index.html:
   - Images: 1.png..13.png (or .jpg)
   - Videos: 1.mp4..4.mp4
-----------------------------------------*/
const IMAGE_COUNT = 13;
const VIDEO_COUNT = 4;

/* state */
let audioCtx, analyser, micStream, rafId, baseline=0.02, threshold=0.12, listening=false, blown=false;
const meterBar = document.getElementById('meterBar');
const micStatus = document.getElementById('micStatus');

/* start & mic permission (must be on a user gesture) */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  // page focuses cake; also tries to enable mic
  document.getElementById('cake-zone').scrollIntoView({behavior:'smooth'});
  await enableMic();
});

document.getElementById('manualBlowBtn').addEventListener('click', extinguishCandles);

/* microphone */
async function enableMic(){
  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      micStatus.textContent="Mic not supported in this browser. Use the button to blow out.";
      return;
    }
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();
    micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true},video:false});
    const source = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024; source.connect(analyser);
    listening=true; blown=false; micStatus.textContent="Listening… blow towards the mic!";
    startLoop(); calibrateNoise();
  }catch(e){
    micStatus.textContent="Mic blocked/unavailable. Tap “Allow” or use the button.";
  }
}
function calibrateNoise(){
  if(!analyser){ return; }
  const data=new Uint8Array(analyser.fftSize); let samples=0,sum=0; const t0=performance.now();
  (function step(){
    analyser.getByteTimeDomainData(data); const v=rms(data); sum+=v; samples++;
    if(performance.now()-t0<1200){ requestAnimationFrame(step); }
    else{ baseline=Math.max(0.01,(sum/samples)); threshold=Math.max(baseline*2.6,0.12);
          micStatus.textContent=`Calibrated ✓ (blow > ${threshold.toFixed(2)})`; }
  })();
}
function startLoop(){
  cancelAnimationFrame(rafId);
  const data = new Uint8Array(analyser.fftSize); let over=0;
  (function loop(){
    analyser.getByteTimeDomainData(data);
    const v = rms(data); meterBar.style.width = Math.min(100, Math.round(v*200)) + "%";
    if(listening && !blown){ over = v>threshold ? over+1 : Math.max(0,over-1); if(over>6) extinguishCandles(); }
    rafId = requestAnimationFrame(loop);
  })();
}
function rms(buf){ let s=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; s+=v*v } return Math.sqrt(s/buf.length) }

/* candle actions */
const flames = [...document.querySelectorAll('.flame')];
const smokes = [...document.querySelectorAll('.smoke')];

function extinguishCandles(){
  if(blown) return;
  blown = true; listening=false;
  flames.forEach(f=>f.classList.add('out'));
  smokes.forEach((s,i)=> setTimeout(()=>{ s.classList.add('show'); setTimeout(()=>s.classList.remove('show'),1100); }, 60*i));
  fireworks();                   // confetti
  revealFilmRoll();              // show film roll
  setTimeout(()=> revealLetter(), 1200); // show greeting card a bit later
  micStatus.textContent="Candles out! Make a wish 🎉";
}
function fireworks(){
  const end = Date.now()+1400;
  (function frame(){
    confetti({particleCount:10,angle:60, spread:60, origin:{x:0}});
    confetti({particleCount:10,angle:120,spread:60, origin:{x:1}});
    if(Date.now()<end) requestAnimationFrame(frame);
  })();
}

/* build film roll (images first, then videos) */
function revealFilmRoll(){
  const zone = document.getElementById('roll-zone');
  const roll = document.getElementById('roll');
  zone.style.display='block';

  // IMAGES 1..13 (try .png then fallback to .jpg)
  for(let i=1;i<=IMAGE_COUNT;i++){
    const item = makeFrame();
    const img = document.createElement('img');
    img.src = `${i}.png`;
    img.alt = `Photo ${i}`;
    img.onerror = ()=>{ img.onerror=null; img.src=`${i}.jpg`; };
    item.querySelector('.mediaSlot').appendChild(img);
    roll.appendChild(item);
  }
  // VIDEOS 1..4
  for(let v=1; v<=VIDEO_COUNT; v++){
    const item = makeFrame();
    const vid = document.createElement('video');
    vid.src = `${v}.mp4`;
    vid.autoplay = true; vid.muted = true; vid.loop = true; vid.playsInline = true; // autoplay mobile-safe
    item.querySelector('.mediaSlot').appendChild(vid);
    roll.appendChild(item);
  }

  // start gentle auto-scroll
  const wrap = document.getElementById('rollWrap');
  let dir=1; (function autoScroll(){
    wrap.scrollTop += dir*0.7;
    const atBottom = Math.abs((wrap.scrollHeight - wrap.clientHeight) - wrap.scrollTop) < 2;
    const atTop = wrap.scrollTop <= 0;
    if(atBottom) dir=-1; if(atTop) dir=1;
    requestAnimationFrame(autoScroll);
  })();
}

/* film frame builder (SVG overlay sides + media slot) */
function makeFrame(){
  const fig = document.createElement('div');
  fig.className = 'frame';
  const slot = document.createElement('div'); slot.className='mediaSlot';
  fig.appendChild(slot);

  const film = document.createElementNS('http://www.w3.org/2000/svg','svg');
  film.setAttribute('viewBox','0 0 300 400'); film.setAttribute('class','film');
  film.innerHTML = `
    <defs>
      <mask id="holes">
        <rect x="0" y="0" width="300" height="400" fill="white"/>
        ${Array.from({length:12}).map((_,k)=>{
          const y=16 + k*32;
          return `<rect x="8" y="${y}" width="22" height="18" rx="3" fill="black"/>`+
                 `<rect x="270" y="${y}" width="22" height="18" rx="3" fill="black"/>`;
        }).join('')}
      </mask>
    </defs>
    <rect x="0" y="0" width="40" height="400" fill="black" mask="url(#holes)"/>
    <rect x="260" y="0" width="40" height="400" fill="black" mask="url(#holes)"/>
    <rect x="40" y="0" width="220" height="8" fill="black" opacity=".6"/>
    <rect x="40" y="392" width="220" height="8" fill="black" opacity=".6"/>
  `;
  fig.appendChild(film);
  return fig;
}

/* letter reveal */
function revealLetter(){ document.getElementById('letter').style.display='block'; }
const envelope = document.getElementById('envelope');
envelope.addEventListener('click', ()=> envelope.classList.toggle('open'));
envelope.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); envelope.classList.toggle('open'); }});
</script>
</body>
</html>
